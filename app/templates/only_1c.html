<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App</title>
    <script type="text/javascript" src="/static/jquery-3.6.4.min.js"></script>
    <!--  линк на стили -->
    <link rel="stylesheet" href="/static/style.css">
    <!--  добавляем фавконку -->
    <link rel="icon" href="/static/w.jpg" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    <link rel="stylesheet" href="/static/loader.css">
    <!-- https://codepen.io/nobuakihonma/pen/dYbqLQ -->
</head>

<body>
    <div class="body_body">
        <div class="top-part">
            <div class="title_1">IT warehouse tracker (Search in 1c)</div>
            <div class="button_exit">
                <a href="/app?t={{ data.token }}" class="menu_arc">Главная</a>
                <a href="/app/only_1c?t={{ data.token }}" class="menu_arc">Поиск по 1с</a>
                {% if data.role == True %}
                <a href="/app/admins_page?t={{ data.token }}" class="menu_arc">Админка</a>
                {% endif %}
                <a href="/accessories?t={{ data.token }}" class="menu_arc">Комплектующие</a>
                <a href="/app/repairs_page?t={{ data.token }}" class="menu_arc">Ремонт</a>
                <a href="/app/trash_page?t={{ data.token }}" class="menu_arc">Списание</a>
                <a href="/geolocation/archive_trash_page?t={{ data.token }}" class="menu_arc">Архив</a>
                <a href="/app/instructions?t={{ data.token }}" class="menu_arc">FAQ</a>
                <a href="/app/auth" class="menu_arc other_buttons">Выйти</a>
            </div>
            <div class="clear"></div>
        </div>



        <div class="counts">
            
            <!-- <p class="p_for_count"><b>Всего пермещений: <div id="movement_count" class="mov_count"></div> </b></p> -->
        </div>
        <!-- <button class="word_button" id="form_file">Скачать информацию по активу (.docx)</button> -->
        <div class="clear"></div>


        <div class="only_search_1c_class">
            <input class="search_1c_class_1" type="text" name="" id="1c-id">
            <input class="search_1c_class_2" id="search_btn" type="button" value="Найти по инвентарному номеру актива в 1С">
        </div>

        <p></p>
        <div id="1c_data" class="1c-data class_for_1c_only">

        </div>
    </div>
    <script>
        const params = new URLSearchParams(window.location.search)
        const access_token = params.get("t");
        var host = document.location.origin;

        async function from_1c(mat_id) {
            try {
                const response = await fetch(host + "/materials/from_1c?id=" + mat_id, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    }
                });
                const json = await response.json();
                return json;
            } catch (error) {
                alert("Произошла ошибка");
                return;
            }
        }
        $(document).ready(function () {
            $("#search_btn").on("click", async ()=>{
                let search_text = $("#1c-id").val();
                let resp = await from_1c(search_text);
                if (resp["success"]){
                    let movement_count = resp.EquipmentData.MovementHistory.length;
                    $("#movement_count").text(movement_count);

                    let current_place = resp.EquipmentData.MovementHistory.CurrentDept;
                    $("#current_place").text(current_place);

                    $("#1c_data").append("<p>Полное имя: "+resp.EquipmentData.FullName + "</p>");
                    $("#1c_data").append("<p>Место где актив принимался на учет: "+resp.EquipmentData.CurrentDept + "</p>");
                    $("#1c_data").append("<p>Дата принятия на баланс: "+resp.EquipmentData.AcceptanceDate + "</p>");
                    $("#1c_data").append("<p>Ответственный (если есть): "+resp.EquipmentData.CurrentPerson + "</p>");
                    $("#1c_data").append("<p>Цена: "+resp.EquipmentData.InitialCost + "$" + "</p>");

                    $("#1c_data").append("<div class='move_class_1'>Перемещения:</div>");

                    for (var i = 0; i<movement_count; i++){ //перебрать все перемещения
                        let movement = "<div class='1c_movement'>";
                            movement += "Накладная: " + resp.EquipmentData.MovementHistory[i].Document + '</br>';
                            movement += "Место: " + resp.EquipmentData.MovementHistory[i].Dept + '</br>';
                            movement += "Ответсвтенный (если есть): " + resp.EquipmentData.MovementHistory[i].Person + '</br>';
                            movement += "----------";
                            movement += "</div>"; //Закрывем тег для одного перемещения
                        $("#1c_data").append(movement);   
                    }

                }
            })
        })
    </script>
</body>

</html>