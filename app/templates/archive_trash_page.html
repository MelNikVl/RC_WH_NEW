<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App</title>
    <script type="text/javascript" src="/static/jquery-3.6.4.min.js"></script>
    <!--  линк на стили -->
    <link rel="stylesheet" href="/static/style.css">
    <!--  добавляем фавконку -->
    <link rel="icon" href="/static/w.jpg" type="image/x-icon">
    <script src="/static/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
</head>

<body>
    <div class="title_1">Main office IT warehouse tracker (ARCHIVE OF TRASH)</div>
    <div class="button_exit"><button id="go_to_auth" class="other_buttons"
            onclick="window.location.href = '/app/auth'">Выйти</button></div>
    <div class="clear"></div>

    <div class="table-wrapper">
        <div class="button-wrapper">
            <button id="go_to_app" onclick='window.location.href = "/app?t="+"{{ data.token }}"'>в приложение</button>
            <button id="go_to_trash" onclick='window.location.href = "/geolocation/trash_page?t="+"{{ data.token }}"'>к списку на списание</button>
        </div>

        <!--  заголовок таблицы -->
        <table class="fl-table" id="table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th>ID актива</th>
                    <th>Кто списывал</th>
                    <th>Категория</th>
                    <th>Номер (тайтл)</th>
                    <th>Описание (характеристики)</th>
                    <th>Прошедшие перемещения</th>
                    <th>Дата списания</th>
                    <th>Ссылка на документацию</th>
                </tr>
            </thead>
            <!--            итерируем по тому переменной которую получаем с фронта. там объект json распаршенный-->
            <tbody>
                {% for item in data[0] %}
                <tr>
                    <td><input type="checkbox"></td>
                    <td>{{ item.id }}</td>
                    <td>{{ item.user_id }}</td>
                    <td>{{ item.category }}</td>
                    <td>{{ item.title }}</td>
                    <td> <textarea cols="20" rows="3">{{ item.description }}</textarea></td>
                    <td>{{ item.moving }}</td>
                    <td>{{ item.date_time }}</td>
                    <td>\\fs-mo\ADMINS\Photo_warehouse\archive_after_utilization\{{ item.folder_name }}</td>
                </tr>
                {% endfor %}
            <tbody>
        </table>
    </div>
    <script>
        $("#form_file").on("click", function () {
            let data = { "data": [] };
            let counter = 1;
            $('tbody > tr').each(function(index){
                let id = $(this).children("td").eq(1).text();
                let category = $(this).children("td").eq(3).text();
                let title = $(this).children("td").eq(4).text();
                let description = $(this).children("td").eq(5).children("textarea").val();
                let date = $(this).children("td").eq(6).text();
                data["data"].push([counter, id, category, title, description, date]);
                counter++;
            });
            download(data);

        });
        async function download(data) {
            try {
                const response = await fetch(host + "/materials/invoice", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + access_token
                    },
                    body: JSON.stringify(data),
                });
                const blob = await response.blob();
                saveAs(blob, "Накладная.docx");
                // window.location.reload();
            } catch (error) {
                console.error(error);
            }
        }
    </script>
</body>

</html>